# Shell path to GCC
ifeq (${OS},Linux)
CC := $(shell which gcc)
CXX := $(shell which g++)
endif

# Debugging flags
CFLAGS := "-O0"
CFLAGS += "-ggdb"
CFLAGS_PIE += "-no-pie"

LIBC_VERSION := "2.31"
LIBC_LOADER_2.31 := $(shell realpath ../../libc_versions/$(LIBC_VERSION)/ld-$(LIBC_VERSION).so)
$(warning	$(LIBC_LOADER_2.31))
SRC_FILE := "stash"
OUT_FILE := "stash"

##############################

all: build patch

build:
	@ ${CC} ${SRC_FILE}.c -o ${OUT_FILE} ${CFLAGS}
	@ ${CC} ${SRC_FILE}.c -o .${OUT_FILE}-2.31 ${CFLAGS} ${CFLAGS_PIE}

patch:
	@ patchelf --set-interpreter ${LIBC_LOADER_2.31} .${OUT_FILE}-2.31

clean:
	@ rm ${OUT_FILE}
	@ rm ${OUT_FILE}-2.31
	@ rm .${OUT_FILE}-2.31

.PHONY: all build patch clean
