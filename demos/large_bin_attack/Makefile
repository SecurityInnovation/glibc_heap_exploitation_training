# Shell path to GCC
ifeq (${OS},Linux)
CC := $(shell which gcc)
CXX := $(shell which g++)
endif

# Debugging flags
CFLAGS := "-O0"
CFLAGS += "-g"
#CFLAGS += "-ggdb"
CFLAGS += "-no-pie"

# Instrumentation flags
#CFLAGS += " -fsanitize=address -Wconversion"

LIBC_VERSION := "2.23"
LIBC_LOADER := $(shell realpath ../../libc_versions/${LIBC_VERSION}/ld-${LIBC_VERSION}.so)

SRC_FILE_1 := "magic_values.c"
OUT_FILE_1 := "magic_values"

SRC_FILE_2 := "large_bin_attack.c"
OUT_FILE_2 := "large_bin_attack"

##############################

all: build patch

build:
	@ ${CC} ${SRC_FILE_1} -o ${OUT_FILE_1} ${CFLAGS}
	@ ${CC} ${SRC_FILE_2} -o ${OUT_FILE_2} ${CFLAGS}
	@
	@ ${CC} ${SRC_FILE_1} -o .${OUT_FILE_1}-${LIBC_VERSION} ${CFLAGS}
	@ ${CC} ${SRC_FILE_2} -o .${OUT_FILE_2}-${LIBC_VERSION} ${CFLAGS}


patch:
	@ patchelf --set-interpreter ${LIBC_LOADER} .${OUT_FILE_1}-${LIBC_VERSION}
	@ patchelf --set-interpreter ${LIBC_LOADER} .${OUT_FILE_2}-${LIBC_VERSION}

clean:
	@ rm ${OUT_FILE_1}
	@ rm ${OUT_FILE_2}
	@
	@ rm .${OUT_FILE_1}-${LIBC_VERSION}
	@ rm .${OUT_FILE_2}-${LIBC_VERSION}

.PHONY: all build patch clean
