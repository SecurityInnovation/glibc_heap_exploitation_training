#include <stdio.h>
#include <stdlib.h>

/*
gcc birdie.c -o birdie -O0 -ggdb
*/
int *ptr_lst[50];
	
void* create_malloc(int index){
	
	int* ptr = malloc(0x30);
	printf("Creating ptr %d\n", index);

	// Sets our index value :) 	
	ptr[1] = index;

	printf("Ptr: 0x%llx - %d\n", ((long long) ptr - 0x10), ptr[1]);
	return ptr;	
}

// Free an item in the array
void* free_array(int* ptr){
	printf("Remove Ptr: 0x%llx\n", ((long long) ptr - 0x10));
	free(ptr);
}

// Show the pointers
void* show_ptrs(int front){
	puts("");
	for(int i = 0; i < front; i++){
		printf("%d - 0x%llx, ", i, ((long long) ptr_lst[i] - 0x10));
	}

	puts("\n");
}

void* options(){
	printf("Options: \n");
	puts("1. Malloc");
	puts("2. Free");
	puts("3. Show Ptrs");
	printf("> ");
}

void banner(){
	puts("Fastbin Challenge");
	puts("-----------------");
	puts("Last In - First Out");
	puts("Malloc(0x30 = 0x40 chunk size");
	puts("Use 'bins' & 'chunks' in GDB");
	puts("\n");
}

// Should be run on a version without tcache
int main(){
	setvbuf(stdout,0,2,0);
        setvbuf(stdin,0,2,0);
	clearenv();	

	char command[10];
	int option;
	int last_index = 0;
	int begin_index = 0;

	// Pre-condition <-- add FIVE ITEMS to the start
	for (int i = 0; i < 5; i++){
		ptr_lst[last_index] = create_malloc(last_index);
		last_index += 1;
	}	

	int index = 0;
	while(index < 8){
		options();

		fgets(command, 10, stdin);
		int option = atoi(command);
		if(option == 1){
			ptr_lst[last_index] = create_malloc(last_index);
			last_index += 1;
			index += 1; 
		}

		else if(option == 2 && begin_index != last_index){
			printf("Removing ptr at index %d\n", begin_index);
			free_array(ptr_lst[begin_index]);
			begin_index = begin_index + 1;
			index += 1; 
		}
		else if(option == 3){
			show_ptrs(last_index);
		}
		else {
			printf("Invalid Input\n");
		}
		
	}

	if(ptr_lst[1][1] == 10){
		printf("Flag...23u40ojfdlJSFOLASJF\n");		
	}
	else {
		puts("Better luck next time!");
	}

	return 0;
}

