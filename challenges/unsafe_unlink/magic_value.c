#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

/* 
Timmy has built his own string class!

Compile: `gcc magic_value.c -o magic_value -g -O0`

Add a size (small and large) 
- Use this THEN create an unlink POC too :) 
*/

long long magic = 0x1337;
char* strings[100]; // Global storage of strings
int string_sizes[100]; 

int get_size(){
	char tmp[8]; 
	char* new_string; 

	// String type
	printf("String Type -- Small (s) or large (l)\n> "); 
	fgets(tmp, 0x8, stdin); 
	if(tmp[0] == 's'){
		return 0x90;
	} 
	else{ 
		return 0xa0; 
	}

	return 0; 
}

char* create_string(int size){

	
	char* new_string = malloc(size); 	
	printf("Please enter your string\n> ");
	// Put data into string	
	read(0, new_string, 0x80);

	return new_string;
}

// Free the string 
int delete_string(char* string){
	free(string);
	printf("String deleted\n");
	return 0;
}


// Edit a string
int* edit_string(char* string, int size){
	printf("Please enter your new string content\n>");
	read(0, string, size); 
}

// View a string
void* view_string(char* string){
	printf("Your string:\n");
	write(1, string, 0x80);
}

void init(){
        setvbuf(stdout, NULL, _IONBF, 0);
        setvbuf(stdin, NULL, _IONBF, 0);
        clearenv();
}

void banner(){
	puts("Welcome to Timmy's strings. This is the CLI to play with:)");
	puts("1. Create New String"); 
	puts("2. Edit Old String"); 
	puts("3. Delete String"); 
	puts("4. View String"); 
	printf(">");
}

int main(){
	init();	
	int option; 
	int iter = 0; 
	char tmp[8];
	int size; 

	while(1){
		// Create String
		banner();
		int option = atoi(fgets(tmp, 8, stdin)); 
		
		if(option == 1){	
			size = get_size(); 
			strings[iter] = create_string(size); 
			string_sizes[iter] = size;
			iter += 1; 
		}
		// Edit String
		else if(option == 2){	
			printf("Index >");
			int option = atoi(fgets(tmp, 7, stdin)); 
	
			if(option >= 0 && option <= iter -1){
				edit_string(strings[option], string_sizes[option]);
			}
			else {
				puts("Improper Index");
			}
		}
		// Delete String
		else if(option == 3){
			printf("Index >");
			int option = atoi(fgets(tmp, 7, stdin)); 
			if(option >= 0 && option <= iter - 1){
				delete_string(strings[option]);
				iter = iter - 1; 
			}
			else {
				puts("Improper Index");
			}

		}
		// View String
		else if(option == 4){
			printf("Index >");
			int option = atoi(fgets(tmp, 4, stdin)); 
			if(option >= 0 && option <= iter - 1){
				view_string(strings[option]);
			}
			else {
				puts("Improper Index");
			}
		}
		else if(option == 5){
			return 1; 
		}
		else if(option == 1337){
			printf("Magic: %lld\n", magic); 
			if(magic > 0x1337){
				puts("Winner!"); 
				return 0; 
			}

		}
	}
}


