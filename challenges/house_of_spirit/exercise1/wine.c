#include <stdio.h>
#include <stdlib.h>
#include <string.h> 


/*
House of Spirit!

- Pointer exists
- Overwrite pointer
- Create a fake size
- Free chunk
- Reallocate this chunk
- Overwrite function pointer

*/

// The drinker
struct drinker {
	char name[0x20];
	char* wine_name; 
};

// State variable for the challenge
struct state{
	long long filler; 
	long long best_age; // Fake chunk location
	void (*show)(); // Function pointer!
};
struct state state; 

// Functions to print the current level of happiness
void show_1(){
	puts("Great wine!");
}

void show_2(){
	puts("Terrible wine... yuk!");
}

// Pops a shell; no questions asked!
void pop_shell(){
	system("/bin/bash");
}

// Initialize the program
void init(){

	state.show = &show_1;
	
	// Ignore this...
        setbuf(stdout, NULL);
        setbuf(stdin, NULL);
        clearenv();
}

// Where all of the fun happens!
int main(){

	init();
	char tmp[0x10];

	// Create the drinker
	struct drinker* wine_drinker;
	wine_drinker = malloc(sizeof(struct drinker)); // 0x30 sized chunk
	wine_drinker->wine_name = malloc(0x20); // 0x30 sized chunk

	// Get the favorite wine of the user
	puts("What is your wine of choice, Mr. Wine?");
	printf("> "); 
	fgets(wine_drinker->wine_name, 0x20, stdin);

	// Get the name of the user
	puts("Oops... I forgot to ask, what is your name?");
	printf("> "); 

	// Buffer overflow (vuln). Overwrite 'wine_name' pointer
	fgets(wine_drinker->name, 0x30, stdin); // Vuln here

	// Get the age of the wine
	puts("What is the best age for wine?");
	printf("> ");
	fgets(tmp, 0x10, stdin); // Put fake chunk size HERE
	state.best_age = atoi(tmp); 

	// Free the standard, as it is NOT being used anymore
	// Perform 'House of Spirit' here
	free(wine_drinker->wine_name); // Free the fake chunk

	// Returns the 'fake chunk' to complete the 'House of Spirit' 
	wine_drinker->wine_name = malloc(0x20); // 0x30 sized chunk

	// Get the wine of the user (2nd) 
	puts("What would you like for you second wine?");
	printf("> "); 
	fgets(wine_drinker->wine_name, 0x20, stdin); // Overwrite function pointer

	// Finish with the function pointer.
	state.show();
}
