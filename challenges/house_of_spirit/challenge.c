#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* 
Compile with `gcc challenge.c -ggdb -o challenge -O0`
*/

// 0x50 bytes
struct sandwich {
	char* jelly_ptr;
	char butter[40];	
	struct sandwich* next;
};

struct sandwich* order_head = NULL;

char resturant_name[100];

// Edits the content of a sandwich
void insert_sandwich_data(struct sandwich* new_wich, int is_new){
	new_wich -> next = NULL;

	// If a new order
	if(is_new){
		// Create the new jelly string 
		new_wich->jelly_ptr = malloc(40);
	}

	// Get jelly	
	printf("Enter Jelly Type: ");
	fgets(new_wich->jelly_ptr, 40, stdin);

	// Get butter 
	printf("Enter Butter Type: ");
	fgets(new_wich->butter, 0x40, stdin);

	// Remove the newlines
	char* newline_loc = strchr(new_wich->butter, '\n');
	if(newline_loc != NULL){
		newline_loc[0] = '\0';
	}
	newline_loc = strchr(new_wich->jelly_ptr, '\n');
	if(newline_loc != NULL){
		newline_loc[0] = '\0';
	}

	return;
}

// Add a new order
// Adds it to the end of the order_head
void add_sandwich(){

	// Create the new sandwich
	struct sandwich* new_wich = malloc(sizeof(struct sandwich));	

	// Add content to the sandwich
	insert_sandwich_data(new_wich, 1);

	// Adding to the linked list
	// If the first item in the linked list
	if(order_head == NULL){
		order_head = new_wich;
		return;
	}	
	
	// Get tail of the linked list
	int index = 0;
	struct sandwich* tmp_sandwich = order_head; 
	while(tmp_sandwich->next != NULL){
		tmp_sandwich = tmp_sandwich->next;	
	}

	// Add the new sandwich order to the end
	tmp_sandwich->next = new_wich;
}

// Edits the most recently made order
void edit_sandwich(){
	
	// Special case for empty
	if(order_head == NULL){
		puts("No orders!");
		return;
	}

	// Find the tail node
	struct sandwich* tmp_sandwich = order_head; 
	while(tmp_sandwich->next != NULL){
		tmp_sandwich = tmp_sandwich->next;	
	}

	// Edit the data for the most recent order
	insert_sandwich_data(tmp_sandwich, 0);
}

// Print a sandwich, given the index
void print_sandwich(int sandwich_index){

	// Find the sandwich to print
	int index = 0;
	struct sandwich* tmp_sandwich = order_head; 
	while(tmp_sandwich != NULL && sandwich_index != index){
		tmp_sandwich = tmp_sandwich->next;	
		index += 1;
	}

	if(tmp_sandwich == NULL){
		puts("No such sandwich :(");
		return; 
	}
	
	printf("You made a %s butter and %s jelly sandwich!\n", tmp_sandwich->butter, tmp_sandwich->jelly_ptr);
	
}

// Remove the sandwich, based upon the index
void remove_sandwich(int sandwich_index){

	struct sandwich* tmp_sandwich = order_head; 

	// Empty list
	if(order_head == NULL){
		return; 
	}	

	// Special case for head.
	if(sandwich_index == 0){
		order_head = order_head->next;
		free(tmp_sandwich);	
		return; 
	}

	// Find the sandwich to delete
	int index = 0;
	while(tmp_sandwich != NULL && (sandwich_index -1) != index){
		tmp_sandwich = tmp_sandwich->next;	
		index += 1;
	}


	if(tmp_sandwich == NULL || tmp_sandwich->next == NULL){
		printf("Cannot delete node :(\n");
		return; 
	}

	// Remove sandwich from the usage
	struct sandwich* fwd_wich = tmp_sandwich->next->next;
	
	free(tmp_sandwich->next);
	tmp_sandwich->next = fwd_wich;	
	puts("Sandwich removed!");
}

// Choose the name of the resturant
void set_resturant(){
	printf("Choose the resturant name to order from:");
	fgets(resturant_name,100,stdin);
}

int get_choice(){
	puts("Peanut Butter Jelly Making Station");
	puts("===================================\n");
	puts("1. Order sandwich");
	puts("2. Eat sandwich");
	puts("3. See my sandwich");
	puts("4. Change Order");
	puts("5. Set Resturant");
	puts("6. Exit");
	printf("> ");

	int choice;
	scanf(" %d", &choice);
	getchar();

	return choice;
}

int main(){

	/*
	
	---------------------------------
	- Arbitrary read via overwriting the 'next' ptr of a new linked list entry
		- However, this is tricky... next + 80 must be 0x0 and writable for this to work.
		- Find a way to leak a libc address via this method.
	- Make a fake_chunk out of the 'name' parameter to run the House of Spirit on (next to PLT/GOT hopefully!)
	- Overwrite this with system or one_gadget after having the chunk over PLT/GOT.	
	*/

	setbuf(stdout, NULL);
	setbuf(stdin, NULL);
	clearenv();

	set_resturant();
	
	int choice = 0;
	while(1){
		choice = get_choice();
		
		if(choice == 1){
			add_sandwich();

		}
		else if(choice == 2){
			printf("Index to remove: ");
			scanf("%d", &choice);
			remove_sandwich(choice);
		}	
		else if(choice == 3){
			printf("Index to view: ");
			scanf("%d", &choice);
			print_sandwich(choice);
		}
		else if(choice == 4){
			edit_sandwich();
		}
		else if(choice == 5){
			set_resturant();	
		}
		else if(choice == 6){
			break;
		}
	}
}
