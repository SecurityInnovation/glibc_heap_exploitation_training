#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* 
Compile with `gcc critic.c -o critic -ggdb -O0
*/

// 0x68 bytes
struct sandwich {
	char butter[60];	
	char* jelly_ptr; // 0x60 bytes
};

// 0x68 bytes
struct review {
	int stars; 
	char* review_notes; 
	char TBD[44]; // To be used for a ranking system of critics in V2
	char* sandwich_name; 
	
}; 

struct review* reviews[20]; 

char critic_name[100];

// Creates the content of a sandwich
struct sandwich* make_sandwich(){
	char tmp_buffer[0x60];

	// The newly made sandwich
	struct sandwich* new_wich = malloc(sizeof(struct sandwich));
	
	// Create the new jelly string 
	new_wich->jelly_ptr = malloc(0x60);

	// Get jelly	
	printf("Enter Jelly Type: ");
	fgets(tmp_buffer, 60, stdin);	
	strcpy(new_wich->jelly_ptr, tmp_buffer);

	// Remove jelly newlines	
	char* newline_loc = strchr(new_wich->jelly_ptr, '\n');
	if(newline_loc != NULL){
		newline_loc[0] = '\0';
	}

	// Get butter 
	printf("Enter Butter Type: ");
	fgets(tmp_buffer, 0x60, stdin);
	strcpy(new_wich->butter, tmp_buffer);

	// Remove the newlines
	newline_loc = strchr(new_wich->butter, '\n');
	if(newline_loc != NULL){
		newline_loc[0] = '\0';

	}
	
	return new_wich;
}


// Add a review for a sandwich
struct review* get_review_data(struct review* new_review){
	
	char tmp_buffer[0x40];
	new_review->review_notes = malloc(44); 

	// The amount of stars	
	printf("How many stars are you giving it?\n>");
	fgets(tmp_buffer, 0x40, stdin);
	new_review->stars = atoi(tmp_buffer);

	// Get the review
        printf("Notes on the take?\n>");
        fgets(tmp_buffer, 44, stdin);
        strcpy(new_review->review_notes, tmp_buffer);
}

// Add a sandwich review!
void review_process(struct sandwich* new_sandwich, int spot){
	char* sandwich_name;

	// The sandwich to eat!
	printf("Here is your %s butter and %s jelly sandwich!\n", new_sandwich->butter, new_sandwich->jelly_ptr);


	// Location for sandwich_name
	sandwich_name = malloc(0x300); 
	strcpy(sandwich_name, new_sandwich->butter); 
	strcat(sandwich_name, " butter and "); 
	strcat(sandwich_name, new_sandwich->jelly_ptr); 
	strcat(sandwich_name, " jelly sandwich"); 

	// Free the sandwich data
	free(new_sandwich->jelly_ptr);
	free(new_sandwich);

	
	// Setup the review data
	struct review* new_review = malloc(sizeof(struct review));

	// Add review to the particular sandwich 
	get_review_data(new_review);
	new_review->sandwich_name = sandwich_name;
	reviews[spot] = new_review; 	
}

// Edits the most recently made order
void edit_review(int spot){
	puts("Another try at the sandwich! :)");	
	get_review_data(reviews[spot]);	
}


// Print a review, given the index
void print_review(int review_index){

	struct review* tmp_review = reviews[review_index];
	printf("Sandwich #%d review\n", review_index);
	puts("======================="); 
	printf("Stars: %d\n", tmp_review->stars); 
	printf("Sandwich Name: %s\n", tmp_review->sandwich_name); 
	printf("Review Text: %s\n", tmp_review->review_notes); 	
}


// Choose the name of the resturant
void set_critic(){
	char tmp_buffer[100]; 
	printf("Choose the resturant name to order from:");
	fgets(tmp_buffer, 100, stdin);

	// Copy string into critic_name
	strcpy(critic_name, tmp_buffer);
}

int get_choice(){
	puts("Peanut Butter Jelly Critic Boards");
	puts("===================================\n");
	puts("1. Order sandwich");
	puts("2. Review sandwich");
	puts("3. View Review");
	puts("4. Re-Review");
	puts("5. Critic Name");
	puts("6. Exit");
	printf("> ");

	int choice;
	scanf(" %d", &choice);
	getchar();

	return choice;
}

int main(){

	/*
	
	---------------------------------
	- Arbitrary read via overwriting the 'next' ptr of a new linked list entry
		- However, this is tricky... next + 80 must be 0x0 and writable for this to work.
		- Find a way to leak a libc address via this method (atoi) ptr
	- Make a fake_chunk out of the 'critic' name
	- Overwrite this with system or one_gadget after having the chunk over PLT/GOT.	
	*/

	setbuf(stdout, NULL);
	setbuf(stdin, NULL);
	clearenv();

	set_critic();

	int cap = 0; 
	int choice = 0;
	struct sandwich* wich = NULL;
	while(1){
		choice = get_choice();
	
		// Make Sandwich	
		if(choice == 1){
			wich = make_sandwich();

		}
		// Review the sandwich
		else if(choice == 2){
			if(wich == NULL){
				puts("You need to eat first!");
				continue;
			}
			review_process(wich, cap); 
			wich = NULL;
			cap += 1; 
		}	
		// See old review
		else if(choice == 3){
			printf("Index to view: ");
			scanf("%d", &choice);
			if(choice >= cap || choice < 0){
				puts("Review DNE!"); 
			}

			print_review(choice);
		}
		// Try the sandwich again
		else if(choice == 4){
			printf("Index to review again: ");
			scanf("%d", &choice);
			if(choice >= cap || choice < 0){
				puts("Review DNE!"); 
			}

			edit_review(choice); 
		}
		// Choose your critici alias
		else if(choice == 5){
			set_critic();	
		}
		else if(choice == 6){
			break;
		}
	}
}
