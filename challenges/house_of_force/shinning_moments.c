#include <stdio.h>
#include <stdlib.h>

/*
Compile: `gcc shinning_moments.c -o shinning_moments -g -fPIE`
*/
void init(){
        setbuf(stdout, NULL);
        setbuf(stdin, NULL);
        clearenv();
}

void* freedom(){
	void* ptr = malloc(0x1024); 
	
	// Heap leak 
	printf("Here's some cash for your story: %p\n", ptr-0x10); 
	free(ptr); 

	// LibC leak 
	printf("And here's a little more: %p\n", &system); 

	// Stack Leak
	printf("Please tell another one, I'll do anything: %p\n", &ptr); 

}

// Easy shell
void* pop_shell(){
	system("/bin/sh");
}

int main(){
	init(); 
	freedom(); 
	
	char* first; // Top chunk location to overwrite
	char* second; // Allocate 'close to' chunk
	char* third; // Overwrite pointer

	unsigned long long size; 
	char tmp[28];

	first = malloc(0x1024); 
	// 'first' chunk becomes part of the top chunk because of consolidation of chunks with the top chunk
	free(first);

	// This overwrites the top chunk prev_size and size!
	printf("What's your shinning moment?\n"); 	
	fgets(first - 0x10, 0x1024, stdin); 

	// Get the size of the allocation 
	printf("How BIG was your moment?\n");
	fgets(tmp, 28, stdin); 	
	size = strtoull(tmp, &third, 10); 

	// Your choice on the size (controlled) 
	// Allocate 'close to' chunk
	second = malloc(size); 

	// Allocate over the top of our pointer
	third = malloc(0x20); 
	printf("Tell me, again, about the moment ;)\n");	
	fgets(third, 0x20, stdin);	

	
	/*
	Targets to overwrite: 
	- GOT entry for puts
	- malloc_hook with call to malloc below
	- stack address
	*/
	puts("Boom goes the dynamite!\n"); 
	malloc(0x0); 
}
