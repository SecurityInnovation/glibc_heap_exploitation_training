#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Ignore this
void init(){
	setvbuf(stdout, NULL, _IONBF, 0);
}

int main(){

	init(); 

	printf("Creating three chunks\n");

	// Buffer overflow vulnerability HERE
	// Use this to overflow the chunk ahead of it. 
	char* first = malloc(0x40 - 0x10); 

	// Corrupt the size of THIS chunk
	char* second = malloc(0x100 - 0x10); 

	// Overlap the previous chunk with this chunk
	char* third = malloc(0x50 - 0x10); 

	// Overwrite the string 'Bill Gates' with 'Steve Jobs' 
	strcpy(third, "Bill Gates");

	//char* fourth = malloc(0x20); // Filler that can be ignored

	printf("First(0x40): %p, Second(0x100): %p, Third(0x30): %p\n", first, second, third); 
	
	printf("Write into 'first' chunk: ");
	fgets(first, 0xa0, stdin); 

	puts("Free chunk 'second'");
	free(second); 

	// Create a new chunk to write into
	puts("Create chunk of size 0x150");
	char* new_ptr = malloc(0x150 - 0x10);
	printf("New Ptr: %p\n", new_ptr); 

	
	// Write into the NEW chunk
	puts("Write into the 'new' chunk");
	fgets(new_ptr, 0x150 - 0x10, stdin); 

	// Print the previous string that we wrote
	printf("String at third chunk: %s\n", third);
}
