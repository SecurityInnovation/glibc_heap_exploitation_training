#include <stdlib.h>
#include <stdio.h>

/*
Fastbin and tcache dupping with fake_chunks. 
Compile: 
- gcc happy.c -o happy -ggdb -O0

In order to run with a non-standard version LibC, change the interpreter of the binary. 
*/

struct kid {
	long age; 
	char name[20];

	void* print_info;
};

typedef struct kid kid;

// Function declarions
void print_kid_younger(kid* my_kid);
void print_older_kid(kid* my_kid);

// Create a kid. 
kid* create_kid(){
	char tmp[20];	

	kid* my_kid = malloc(sizeof(kid));

	// Get the kids information
	printf("Kids name : ");	
	fgets(my_kid->name,20,stdin);

	printf("Kids age : ");		
	fgets(tmp,10,stdin);
	my_kid->age = atoi(tmp);
	
	// Determine style...
	if(my_kid->age < 10){
		my_kid->print_info = &print_kid_younger;
	}else{
		my_kid->print_info = &print_older_kid;
	}
	
	return my_kid;
}

kid* edit_kid(kid* my_kid)
{ 
	char tmp[20];

	printf("You damn kids never change... well, now it's time!\n");

        // Get the kids information
        printf("Kids name : ");
        fgets(my_kid->name,20,stdin);

        printf("Kids age : ");
        fgets(tmp,10,stdin);
        my_kid->age = atoi(tmp);
	
	return my_kid;
}

// Remove the kid
void dump_kid(kid* my_kid)
{
	puts("Get out of here you..."); 
	free(my_kid);	
}

void print_kid_younger(kid* my_kid){
	puts("Kids information...");	
	puts("====================");
	printf("Name : %s\n", my_kid->name);	
	printf("Age  : %ld\n", my_kid->age);
	printf("If you're happy and you know it clap your hands...\n");	
}

void print_older_kid(kid* my_kid){
        puts("Kids information...");
        puts("====================");
        printf("Name : %s\n", my_kid->name);
        printf("Age  : %ld\n", my_kid->age);
	printf("Get on the ground you freaking teenager! listen here you son of a *(&&)\n");
}

void init(){
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	clearenv();
}

int get_option(){
	char tmp[20];
	
	fgets(tmp,10,stdin);
	return atoi(tmp);
}

// hit this to win!
void win(){
	system("/bin/bash");
}

int main(){

	int option;
	
	kid* all_kids[5];
	int counter = 0;
	init();

	// Options...
	puts("Have a kid, without getting pregnant!");
	puts("=====================================");
	puts("1. Have a kid");
	puts("2. See a kid");
	puts("3. Free a kid");
	puts("4. Change a kid");
	puts("5. Exit");

	while(1){
		printf(">");		

		option = get_option();
		if(option == 1){
			all_kids[counter] = create_kid();
			counter += 1;
		}

		// Print a given kid
		else if(option == 2){
			printf("Kid # : ");
			option = get_option();
			
			if(option < counter && option >= 0){
				void (*func_ptr)(int);	
				func_ptr = all_kids[option]->print_info;
				func_ptr(all_kids[option]);
			}else {
				puts("Failed to print...");
			}
			
		}

		// Free a kid
		else if(option == 3){	
                        printf("Kid # : ");
                        option = get_option();
 
                        if(option < counter && option >= 0){
				dump_kid(all_kids[option]);
                        }else{
				printf("Failed to free...");
			}
	
		}
		// Edit a kid?
		else if(option == 4){
                        printf("Kid # : ");
                        option = get_option();

                        if(option < counter && option >= 0 && all_kids[option] != 0x0){
                                all_kids[option] = edit_kid(all_kids[option]);
                        }else{
                                printf("Failed to edit...");
                        }


		}	
		else if(option == 5){
			return 0;
		}
	}
}
