#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>

/*
Compile: `gcc coins.c -o coins -g -O0 -Wl,-z,relro,-z,now -fPIE -pie`
*/

int DESC_SIZE = 0x1000;
struct coin {
	long long value; 
	char* head_desc; 
	char* tail_desc; 
	} coin;

struct coin* coins[10]; 

/*
Creates a new coin (max of 10) 
Returns: 
	- A pointer to a coin

*/
struct coin* make_coin(){

	char tmp_buf[16];

	// Allocate the memory for the coin
	struct coin* new_coin = malloc(sizeof(struct coin));
	
	new_coin->tail_desc = malloc(DESC_SIZE);
	new_coin->head_desc = malloc(DESC_SIZE);

	// Get values for the coin
	puts("Design for the front of the coin: ");
	fgets(new_coin->head_desc, DESC_SIZE, stdin);

	puts("Design for the back of the coin: ");
	fgets(new_coin->tail_desc, DESC_SIZE, stdin);

	puts("Value for the coin:");
	read(0,tmp_buf,16);	
	new_coin->value = atoll(tmp_buf);

	// Add coin to the global array 
	for(int i = 0; i < 10; i++){
		if(coins[i] == NULL){
			coins[i] = new_coin;	
			printf("Coin added to slot %d\n", i);
			return new_coin;
		}
	}
	printf("Coin slots are full! Coin not added\n");
	return NULL;
} 

/*
Removes a coin
Parameter: 
	- A pointer to a core
*/
void remove_coin(struct coin* cur){

	// Iterates through the entire list to find the coin
	for(int i = 0; i < 10; i++){
		if(coins[i] == cur){
			free(coins[i]->head_desc); 
			free(coins[i]->tail_desc);
			free(coins[i]);	
			coins[i] = NULL;
			printf("Removed coin at index %d\n", i);
			return; 
		}
	}
}

/*
View a coin. Just prints the contents of the coin 
Parameter: 
	- A pointer to a coin
*/
void see_coin(struct coin *cur){
	printf("Your coin\n=============================\n");
	printf("Head Design: %s\n", cur->head_desc);
	printf("Tail Design: %s\n", cur->tail_desc);
	printf("Worth: %lld\n", cur->value);	
}


/*
Edit a coin. 
Parameter: 
	- Pointer to a coin
*/
void edit_coin(struct coin* old_coin){

	char tmp_buf[DESC_SIZE];

	memset(tmp_buf, 0x0, DESC_SIZE); // Clear the buffer

	// Get values for the coin. Enter nothing to skip altering
	puts("Edited design for the front of the coin: ");
	fgets(tmp_buf, DESC_SIZE, stdin); 
	if(strcmp(tmp_buf, "\n") != 0x0){
		strcpy(old_coin->head_desc, tmp_buf);
	}

	memset(tmp_buf, 0x0, DESC_SIZE); // Clear the buffer
	puts("Edited design for the back of the coin: ");
	fgets(tmp_buf, DESC_SIZE, stdin); 
	if(strcmp(tmp_buf, "\n") != 0x0 ){ // If null, do not alter the buffer
		strcpy(old_coin->tail_desc, tmp_buf);
	}

	// Get the value for the coin
	puts("Edited value for the coin: ");
	read(0,tmp_buf,16);	
	old_coin->value = atoll(tmp_buf);
}

/* 
Select which coin to use.
Returns: 
	- A pointer to a coin
*/
struct coin* select_coin(){
	char buf[4]; 
	int index;

	printf("Select Index: ");
	fgets(buf, 4, stdin);

	index = atoi(buf);	
	if(index < 0 || index > 10){
		printf("Invalid index: out of range\n");
		return NULL;
	}
		
	if(coins[index] != NULL){
		return coins[index];
	}
	else{
		printf("Invalid index: no coin here\n");
		return NULL;
	}
}

void banner(){
	puts("Options");
	puts("========");
	puts("1. Select Coin"); 
	puts("2. Make Coin"); 
	puts("3. Edit Coin"); 
	puts("4. See Coin"); 
	puts("5. Remove Coin"); 
	puts("6. Exit"); 
	printf("> "); 


}

int main(){

	// Turn off buffering and remove env variables
	setvbuf(stdout,0,2,0);
	setvbuf(stdin,0,2,0);
	clearenv(); 

	char buf[4]; 
	int option = 0;
	struct coin* cur_coin = NULL;


	while(1){
		banner();
		fgets(buf, 4, stdin);
		option = atoi(buf);			

		// Select a coin		
		if(option == 1){
			cur_coin = select_coin();	
		}
		// Make a coin
		else if(option == 2){
			cur_coin = make_coin();
		}
		// Edit/alter a coin
		else if(option == 3 && cur_coin != NULL){
			edit_coin(cur_coin);
		}
		// View the contents of the coin
		else if(option == 4 && cur_coin != NULL){
			see_coin(cur_coin);
		}
		// Removes from the list
		else if(option == 5 && cur_coin != NULL){
			remove_coin(cur_coin);			
			
		}
		else if(option == 6){
			break;
		}
	}

	return 0;
}
