#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// 88 bytes
struct sandwich {
	char jelly[40];
	char butter[40];	
	struct sandwich* next;
};

struct sandwich* sandwich_head = NULL;

char chef_name[40];

void add_sandwich(){

	// Create the new sandwich
	struct sandwich* new_wich = malloc(sizeof(struct sandwich));	

	new_wich -> next = NULL;
	// TODO: Remove the newlines (they're very annoying)
	// Get jelly	
	printf("Enter Jelly Type: ");
	fgets(new_wich->jelly, 40, stdin);

	// Get butter 
	printf("Enter Butter Type: ");
	fgets(new_wich->butter, 0x40, stdin);

	// Remove newlines from the strings
	int len = strlen(new_wich->jelly);
	if(new_wich->jelly[len-1] == '\n'){
		new_wich->jelly[len-1] = '\0';
	}
	len = strlen(new_wich->butter);
	if(new_wich->butter[len-1] == '\n'){
		new_wich->butter[len-1] = '\0';
	}


	// Adding to the linked list

	// If the first item in the linked list
	if(sandwich_head == NULL){
		sandwich_head = new_wich;
		return;
	}	
	
	// Get tail of the linked list
	int index = 0;
	struct sandwich* tmp_sandwich = sandwich_head; 
	while(tmp_sandwich->next != NULL){
		tmp_sandwich = tmp_sandwich->next;	
		index += 1;
	}

	// Add the new sandwich to the end
	tmp_sandwich->next = new_wich;
}

// Print a sandwich, given the index
void print_sandwich(int sandwich_index){

	// Find the sandwich to print
	int index = 0;
	struct sandwich* tmp_sandwich = sandwich_head; 
	while(tmp_sandwich->next != NULL && sandwich_index != index){
		tmp_sandwich = tmp_sandwich->next;	
		index += 1;
	}

	if(tmp_sandwich->next == NULL){
		puts("No such sandwich :(");
		return; 
	}
	
	printf("You made a %s butter and %s jelly sandwich!\n", tmp_sandwich->butter, tmp_sandwich->jelly);
	
}

// Remove the sandwich, based upon the index
void remove_sandwich(int sandwich_index){

	struct sandwich* tmp_sandwich = sandwich_head; 

	// Empty list
	if(sandwich_head == NULL){
		return; 
	}	

	// Special case for head.
	if(sandwich_index == 0){
		sandwich_head = sandwich_head->next;
		free(tmp_sandwich);	
		return; 
	}

	// Find the sandwich to delete
	int index = 0;
	while(tmp_sandwich != NULL && (sandwich_index -1) != index){
		tmp_sandwich = tmp_sandwich->next;	
		index += 1;
	}


	if(tmp_sandwich == NULL || tmp_sandwich->next == NULL){
		printf("Cannot delete node :(\n");
		return; 
	}

	// Remove sandwich from the usage
	struct sandwich* fwd_wich = tmp_sandwich->next->next;
	
	free(tmp_sandwich->next);
	tmp_sandwich->next = fwd_wich;	
	puts("Sandwich removed!");
}

// Get the name of the newest and greatest chef
void save_sandwiches(){
	// TODO: Need to add this feature later
	char* tmp = malloc(0x1000);	
}

int get_choice(){
	puts("Peanut Butter Jelly Making Station");
	puts("===================================\n");
	puts("1. Make butter and jelly sandwich");
	puts("2. Remove sandwich");
	puts("3. See sandwich");
	puts("4. Exit");
	printf("> ");

	int choice;
	scanf(" %d", &choice);
	getchar();

	return choice;
}

int main(){

	/*
	
	---------------------------------
	- Arbitrary read via overwriting the 'next' ptr of a new linked list entry
		- However, this is tricky... next + 80 must be 0x0 and writable for this to work.
		- Find a way to leak a libc address via this method.
	- Make a fake_chunk out of the 'name' parameter to run the House of Spirit on (next to PLT/GOT hopefully!)
	- Overwrite this with system or one_gadget after having the chunk over PLT/GOT.	
	*/

	setbuf(stdout, NULL);
	setbuf(stdin, NULL);

	printf("What is the chefs name: ");
	fgets(chef_name,40,stdin);

	int choice = 0;
	int iteration = 0;
	while(1){
		choice = get_choice();
		
		if(choice == 1){
			add_sandwich();

		}
		else if(choice == 2){
			printf("Index to remove: ");
			scanf("%d", &choice);
			remove_sandwich(choice);
		}	
		else if(choice == 3){
			printf("Index to view: ");
			scanf("%d", &choice);
			print_sandwich(choice);
		}
		else if(choice == 4){
			printf("You made %d moves!\n", iteration);
			break;
		}
		else if(choice == 1337){
			save_sandwiches();
		}
	}
	iteration += 1;
}
