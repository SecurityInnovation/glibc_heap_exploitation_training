FROM ubuntu:20.04

# Install all of the important things
RUN apt-get update -y && DEBIAN_FRONTEND="noninteractive" TZ="America/New_York" apt install openssh-server g++-multilib vim gdb gcc python git curl bsdmainutils nano tmux -y unzip patchelf make nano 

# Install pwndbg
RUN git clone https://github.com/pwndbg/pwndbg && cd pwndbg && ./setup.sh

RUN pip3 install pwntools

# Create the 'pwn_heap' user
RUN useradd -d /home/pwn_heap -m -p pwn_heap -s /bin/bash pwn_heap 

# Setup the bash aliases for things
ADD bashrc /root/.bashrc
ADD bashrc /home/pwn_heap/.bashrc

# .gdbinit load things
RUN echo "set auto-load safe-path /" >> /root/.gdbinit
RUN echo "set auto-load safe-path /" >> /home/pwn_heap/.gdbinit
RUN echo "source /home/pwn_heap/Desktop/tools/pwndbg/gdbinit.py" >> /home/pwn_heap/.gdbinit


# Copy over the VM material - this starts from the 'Desktop' directory
ADD VM.zip /

# Unzip the directory 
RUN unzip VM.zip -d /home/pwn_heap

# Build everything out
RUN cd /home/pwn_heap/Desktop/heap_training/ && make
RUN chown -R pwn_heap:pwn_heap /home/pwn_heap/* /home/pwn_heap/.*

# Turn on SSH to allow people to log into this
RUN mkdir /var/run/sshd
EXPOSE 22/tcp 
ENTRYPOINT service ssh restart && sleep 5d


