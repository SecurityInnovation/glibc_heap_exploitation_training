# Shell path to GCC
ifeq (${OS},Linux)
CC := $(shell which gcc)
CXX := $(shell which g++)
endif

# Debugging flags
CFLAGS := "-O0"
CFLAGS += "-ggdb"
CFLAGS += "-no-pie"
CFLAGS += "-Wl,-z,relro,-z,now"

# Instrumentation flags
#CFLAGS += " -fsanitize=address -Wconversion"

LIBC_VERSION := "2.23 2.26 2.32"
LIBC_LOADER_2.23 := $(shell realpath ../../../libc_versions/$(word 1, ${LIBC_VERSION})/ld-$(word 1, ${LIBC_VERSION}).so)
LIBC_LOADER_2.26 := $(shell realpath ../../../libc_versions/$(word 2, ${LIBC_VERSION})/ld-$(word 2, ${LIBC_VERSION}).so)
LIBC_LOADER_2.32 := $(shell realpath ../../../libc_versions/$(word 3, ${LIBC_VERSION})/ld-$(word 3, ${LIBC_VERSION}).so)

SRC_FILE := "happy.c"
OUT_FILE := "happy"

##############################

all: build patch

build:
	@ ${CC} ${SRC_FILE} -o ${OUT_FILE} ${CFLAGS}
	@ ${CC} ${SRC_FILE} -o .${OUT_FILE}-2.23 ${CFLAGS}
	@ ${CC} ${SRC_FILE} -o .${OUT_FILE}-2.26 ${CFLAGS}
	@ ${CC} ${SRC_FILE} -o .${OUT_FILE}-2.32 ${CFLAGS}

patch:
	@ patchelf --set-interpreter ${LIBC_LOADER_2.23} .${OUT_FILE}-2.23
	@ patchelf --set-interpreter ${LIBC_LOADER_2.26} .${OUT_FILE}-2.26
	@ patchelf --set-interpreter ${LIBC_LOADER_2.32} .${OUT_FILE}-2.32

clean:
	@ rm ${OUT_FILE}
	@ rm .${OUT_FILE}-2.23
	@ rm .${OUT_FILE}-2.26
	@ rm .${OUT_FILE}-2.32

.PHONY: all build patch clean
