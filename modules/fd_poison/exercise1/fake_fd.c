#include <stdlib.h>
#include <stdio.h>

char important_string[0x20] = "You can't touch this"; 

int main(){
	setvbuf(stdout, NULL, _IONBF, 0);

	// Allocate two chunks of size 0x30 
	char* data = malloc(0x20); 
	char* data2 = malloc(0x20); 

	// Put into 0x30 tcache bin
	free(data2);	

	// Put the chunk into the 0x30 tcache bin
	// Creates a use after free (UAF)
	free(data); 	

	/*
	At this point, the linked list looks like this (TCache is FIFO):
	data -> data2
	
	Overwrite the pointer for 'data2' for our fake
	fd.
	*/
	printf("Enter Data: ");

	// Write into the data variable after it has been freed
	// Exploit use after free!!
	fgets(data, 0x20, stdin); 

	// Allocate new chunk
	// Breakpoint 1 here!
	malloc(0x20); 

	printf("Enter victim: "); 

	// Alocate our fake chunk
	// Breakpoint 2 here!
	char* victim = malloc(0x20); 

	// Write into the fake chunk
	fgets(victim, 0x20, stdin);

	printf("Important String: %s\n", important_string); 
	return 0; 
}
