#include <stdlib.h>
#include <stdio.h>

/*
Goal: Get the chunk in 'index 1' to be in the 10th slot of the array
Unsorted bin is used for ALL of these chunks.
Unsorted Bin is FIFO!
*/
int *ptr_lst[50];

// Create a chunk and add it
void* create_malloc(int index){
	
	int* ptr = malloc(0x100);
	printf("Creating ptr %d", index);

	// Show if this is the target chunk.	
	if(index == 1){
		printf(" <-------- target\n");
	}else{
		printf("\n");
	}
	
	// FILLER TO PREVENT CONSOLIDATION
	malloc(0x110);

	// Sets our index value :) 	
	ptr[1] = index;

	printf("Ptr: 0x%llx - %d\n", ((long long) ptr - 0x10), ptr[1]);
	return ptr;	
}

// Free an item in the array
void* free_array(int* ptr){
	// Puts chunk into the unsorted bin
	printf("Remove Ptr: 0x%llx\n", ((long long) ptr - 0x10));
	free(ptr);
}

// Show the pointers
void* show_ptrs(int front){
	puts("");
	for(int i = 0; i < front; i++){
		if(i == 1){
	        printf("%d - 0x%llx <------- target \n", i, ((long long) ptr_lst[i] - 0x10));
		}
		else {
			printf("%d - 0x%llx \n", i, ((long long) ptr_lst[i] - 0x10));
		}
	}

	puts("\n");
}

void* options(){
	printf("Options: \n");
	puts("1. Malloc");
	puts("2. Free");
	puts("3. Show All Ptrs");
	printf("> ");
}

void banner(){
	puts("Unsorted Bin Ordering Challenge");
	puts("----------------------");
	puts("First In - First out");
	puts("Malloc(0x100) = 0x110 chunks");
	puts("Use 'bins' & 'chunks' in GDB");
	puts("NOTE: Ignore 0x120 (0x110) allocations.");
	puts("\n");
}

// Should be run on a version without tcache
int main(){
	setvbuf(stdout,0,2,0);
        setvbuf(stdin,0,2,0);
	clearenv();	
	banner(); 

	char command[10];
	int option;
	int last_index = 0;
	int begin_index = 0;

	// Pre-condition <-- add SIX ITEMS to the start
	for (int i = 0; i < 6; i++){
		ptr_lst[last_index] = create_malloc(last_index);
		last_index += 1;
	}	

	int index = 0;
	while(index < 7){
		options();

		fgets(command, 10, stdin);
		int option = atoi(command);
		if(option == 1){
			ptr_lst[last_index] = create_malloc(last_index);
			last_index += 1;
			index += 1; 
		}

		else if(option == 2 && begin_index != last_index){
			printf("Removing ptr at index %d\n", begin_index);
			free_array(ptr_lst[begin_index]);
			begin_index = begin_index + 1;
			index += 1; 
		}
		else if(option == 3){
			show_ptrs(last_index);
		}
		else {
			printf("Invalid Input\n");
		}
		
	}

	// Check to see if this is a WINNER
	if(ptr_lst[1][1] == 10){
		printf("Flag...23u40ojfdlJSFOLASJF\n");		
	}

	return 0;
}

