#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>

int main(){
	char tmp[0x10];
	// Allowing socat to work
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);

	
	// Mem: 0x10, Chunk: 0x0, Size: 0xa0
	uint8_t* previous = malloc(0x90); 
	
	// Chunk that NEEDS to be fixed
	// Mem: 0xb0, Chunk: 0xa0, Size: 0x110
	uint8_t* current = malloc(0x100);

	// Prevent consolidation with top chunk
	// Mem: 0x1d0, Chunk: 0x1c0, Size: 0x20
	uint8_t* filler = malloc(0x10); 

	printf("Memory 1 (previous): %p\n", previous);
	printf("Memory 2 (current): %p\n", current);
	printf("Memory 3 (filler): %p\n", filler); 

	// Put the bottom chunk  (Memory 1) into a free list.
	//free(previous); // To make the challenge slightly harder, add this in here.

	// Move the ptr to the back of the chunk instead of the 'memory'
	uint8_t* chunk = current - 0x10;
	printf("Ptr to memory: %p\n", current);
	printf("Ptr to actual chunk: %p\n", chunk);
	printf("Prev Size: 0x%x\n", *chunk);
	printf("Size: 0x%x\n", *((int*)(chunk + 0x8)));

	// PAUSE to allow easy debugging
	puts("Press enter to continue");
	fgets(tmp, 0x10, stdin);

	// Clear the chunk data
	memset(chunk, 0x0, 0x10);

	// Enter data to fix the chunk
	printf("Enter data to fix the chunk: ");
	read(0, chunk, 0x10);

	// Free the top chunk
	free(current); // First breakpoint set here!

	puts("Hooray! The chunks okay :)");
	return 0;

}
