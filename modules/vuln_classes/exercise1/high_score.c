#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <string.h>

/*
Use after free challenge!

Hint: Look at the mallocs and frees. 
*/
// 16 or 0x10 bytes
struct player {
    char name[12]; // 12 bytes
    int score; // 4 bytes
}; 


// Scores of previous players
int scores[20] = {17,25,26,39,54,67,92,101};
int total_size = 8; 

// Global player struct
struct player *player; 

/*
Check to see if the player got the high score!
*/
int is_high_score(int score){

    // Not high score 
    if(score < scores[total_size -1]){
        return 0;
    }

    // High score!
    scores[total_size] = score; 
    score++; 
    return 1; 
}

// Get the random score for the user. 
int add_score(int* p_array){

    int r; 
    int total = 0;

    // p_array = 100, 101, 102, 103
    for(int i = 0; i < 4; i++){
        p_array[i] = i+100;  
    }

    /* 
    Largest possible score is 100!
    */
    for(int i =0; i < 4; i++){
        r = rand() % 16; // Get a random value
        total = total + r + (p_array[i] - 90);
    }

    return total; 
}

// Setup the randomness and other things (can be ignored!)
void setup(){
    setvbuf(stdout,0,2,0);
    setvbuf(stdin,0,2,0);
    clearenv();
    srand(time(NULL)); 

}

void print_options(){
    puts("Options"); 
    puts("=============");
    puts("1. Malloc - Create a player");
    puts("2. Free - Delete a player");
    puts("3. Use - Play the game");
    puts("4. Set - Use the current score on the 'won' call");
    puts("5. Won - Check to see if you won");
    puts("6. Exit");
    printf(">");
}

int main(){
    setup();

    char line[128];
    int option; 
    
    int new_score; 
    puts("This is a game about who can get the highest score! The highest score seen in 100; can you break the high score?");

    // Loop to play the game.
    while(1){
        print_options();

        // Gets the input
        if(fgets(line, sizeof(line), stdin) == NULL) break;
        option = atoi(line);

        // Malloc - Create the user
        if(option == 1){

            player = malloc(0x10); // 0x20 sized chunk
            memset(player, 0, 0x10);

            // Initialize the player
            puts("Please enter the players name: ");
            if(fgets(player->name, 12, stdin) == NULL) break;

            player->score=0;
            printf("Player name is set to %s\n", player->name);
        }

        // Ensure the player pointer exists prior to operating on it
        else if(player == NULL){
            puts("Create player first!");
        }

        // Free - Deletes the current player
        else if(option == 2){
            free(player);
            puts("Player has been removed!");
        }

        // Plays the game!
        else if(option == 3){

            /*
            Create array of integers on the heap
            Each integer is 4 bytes in size.
            */
            int *p_array = (int *)malloc(0x10); // 0x20 sized chunk
            new_score = add_score(p_array); 
            free(p_array); 

            printf("Your new score is %d\n", new_score);
        }

        // Set - Set the total high score for the player
        else if(option == 4){
            player->score = new_score; 
        }

        // Won - Checks to see if the user has the high score!
        else if(option == 5){

            printf("\nPlayer->name: %s, \nPlayer->score %d\n", player->name, player->score);

            // Checks to see if the user has the high score.
            int high_score = is_high_score(player->score);
            if(high_score){
                puts("flg{UAF}");
            }else{
                puts("Not the high score. Keeping trying :)");
            }
        }else if(option == 6){
            puts("Exiting!"); 
        }else{
            puts("Invalid option");
        }
    }

return 0;
}
