# Shell path to GCC
ifeq (${OS},Linux)
CC := $(shell which gcc)
CXX := $(shell which g++)
endif

# Debugging flags
CFLAGS := "-g"
CFLAGS += "-D_FORTIFY_SOURCE=2"

CFLAGS_PIE := "-fPIE"
CFLAGS_PIE += "-pie"

CFLAGS_RELRO := "-Wl,-z,relro,-z,now"

# Instrumentation flags
#CFLAGS += " -fsanitize=address -Wconversion"

LIBC_VERSION := "2.31"
LIBC_LOADER := $(shell realpath ../../../libc_versions/${LIBC_VERSION}/ld-${LIBC_VERSION}.so)

SRC_FILE := "book_shop.c"
OUT_FILE := "book_shop"

##############################

all: build patch

build:
	@ ${CC} ${SRC_FILE} -o ${OUT_FILE} ${CFLAGS} ${CFLAGS_PIE} ${CFLAGS_RELRO}
	@ ${CC} ${SRC_FILE} -o .${OUT_FILE}-${LIBC_VERSION} ${CFLAGS} ${CFLAGS_PIE} ${CFLAGS_RELRO}
	@
	@ ${CC} ${SRC_FILE} -o ${OUT_FILE}-leakless ${CFLAGS}
	@ ${CC} ${SRC_FILE} -o .${OUT_FILE}-leakless ${CFLAGS}

patch:
	@ patchelf --set-interpreter ${LIBC_LOADER} .${OUT_FILE}-${LIBC_VERSION}
	@ patchelf --set-interpreter ${LIBC_LOADER} .${OUT_FILE}-leakless

clean:
	@ rm ${OUT_FILE}
	@ rm .${OUT_FILE}-${LIBC_VERSION}
	@
	@ rm ${OUT_FILE}-leakless
	@ rm .${OUT_FILE}-leakless

.PHONY: all build patch clean
