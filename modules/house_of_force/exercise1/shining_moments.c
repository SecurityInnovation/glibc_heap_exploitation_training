#include <stdio.h>
#include <stdlib.h>

/*
House of Force exercise
*/
void init(){
        setbuf(stdout, NULL);
        setbuf(stdin, NULL);
        clearenv();
}

// Leaks that show up. Ignore the heap allocations in here.
void* freedom(){
	void* ptr = malloc(0x1024); 
	
	// Heap leak 
	printf("Here's some cash for your story: %p\n", ptr-0x10); 
	free(ptr); 

	// LibC leak 
	printf("And here's a little more: %p\n", &system); 

	// Stack Leak
	printf("Please tell another one, I'll do anything: %p\n", &ptr); 

}

// Easy shell to be called later.
void* pop_shell(){
	system("/bin/sh");
}

int main(){
	init(); 
	freedom(); 
	
	char* first; // Top chunk location to overwrite (step 1)
	char* second; // Allocate 'close to' chunk (step 2) 
	char* third; // Overwrite pointer (step 3) 

	unsigned long long size; 
	char tmp[28];

	first = malloc(0x1024); 
	// 'first' chunk becomes part of the top chunk because of consolidation of chunks with the top chunk
	free(first);

	// This overwrites the top chunk prev_size and size! **vuln**
	printf("What's your shining moment?\n"); 	
	fgets(first - 0x10, 0x1024, stdin); // Breakpoint #1 -- Step 1

	// Get the size of the next allocation 
	printf("How BIG was your moment?\n");
	fgets(tmp, 28, stdin); 	
	size = strtoull(tmp, &third, 10); 

	// Allocate 'close to' target with user controlled size 
	second = malloc(size); // Step 2

	// Allocate over the top of our 'target'
	third = malloc(0x20); // Breakpoint #2 -- Step 3
	printf("Tell me, again, about the moment ;)\n");	
	fgets(third, 0x20, stdin);	

	/*
	Targets to overwrite: 
	- GOT entry for puts
	- __malloc_hook with call below
	- stack address
	*/
	puts("Boom goes the dynamite!\n");
	malloc(0x0); 
}
