#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Ignore this
void init(){
	setvbuf(stdout, NULL, _IONBF, 0);
}

int main(){

	init(); 

	printf("Creating three chunks\n");

	// Buffer overflow vulnerability HERE
	// Use this to overflow the chunk ahead of it. 
	char* first = malloc(0x40 - 0x10); // 0x40 sized chunk

	// Corrupt the size of THIS chunk
	char* second = malloc(0x100 - 0x10); // 0x100 sized chunk

	// Overlap the previous chunk with this chunk
	char* third = malloc(0x50 - 0x10);  // 0x50 sized chunk

	// Overwrite the string 'Bill Gates' with 'Steve Jobs' 
	strcpy(third, "Bill Gates");

	printf("First(0x40): %p, Second(0x100): %p, Third(0x50): %p\n", first, second, third); 
	
	printf("Write into 'first' chunk: ");
	fgets(first, 0xa0, stdin); 

	puts("Free chunk 'second'"); // First Breakpoint
	free(second); 

	// Create a new chunk to write into
	puts("Create chunk of size 0x150");
	char* fourth = malloc(0x150 - 0x10); // 0x150 sized chunk. Second breakpoint.
	printf("Fourth(0x150): %p\n", fourth); 

	// Write into the NEW chunk
	puts("Write into the 'new' chunk");
	fgets(fourth, 0x150 - 0x10, stdin); // Third breakpoint!

	// Print the previous string that we wrote
	printf("String at third chunk: %s\n", third);
}
